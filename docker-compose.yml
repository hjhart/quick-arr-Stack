services:
  gluetun: #Vpn
    image: qmcgaw/gluetun
    container_name: gluetun
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
    environment:
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER=${OPENVPN_USER}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}
      - SERVER_REGIONS=CA Vancouver
    ports:
      - 8112:8112 # deluge
      - 6881:6881 # deluge
      - 6881:6881/udp # deluge
    volumes:
      - '${ROOT}/MediaCenter/config/gluetun:/gluetun'
    labels:
      - "com.centurylinklabs.watchtower.enable=true" 
    restart: always

  deluge: #downloader
    container_name: deluge
    image: 'lscr.io/linuxserver/deluge:latest'
    restart: unless-stopped
    environment:
      - 'PUID=${PUID}'
      - 'PGID=${PGID}'
      - 'TZ=${TZ}'
    volumes:
      - '${ROOT}/MediaCenter/config/deluge:/config'
      - '${HDDSTORAGE}:/MediaCenterBox'
    network_mode: 'service:gluetun'
    depends_on:
      - gluetun

  prowlarr: #indexer
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - 'TZ=${TZ}'
    volumes:
      - '${ROOT}/MediaCenter/config/prowlarr:/config'
    restart: unless-stopped
    ports:
      - '9696:9696' #uncomment if you are not using the VPN

  sonarr: #tv series
    container_name: sonarr
    image: 'lscr.io/linuxserver/sonarr:latest'
    restart: unless-stopped
    network_mode: host
    environment:
      - 'PUID=${PUID}'
      - 'PGID=${PGID}'
      - 'TZ=${TZ}'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '${ROOT}/MediaCenter/config/sonarr:/config'
      - '${HDDSTORAGE}:/MediaCenterBox'
    ports: 
      - '8989:8989'

  radarr: #movies
    container_name: radarr
    image: 'lscr.io/linuxserver/radarr:latest'
    restart: unless-stopped
    network_mode: host
    environment:
      - 'PUID=${PUID}'
      - 'PGID=${PGID}'
      - 'TZ=${TZ}'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '${ROOT}/MediaCenter/config/radarr:/config'
      - '${HDDSTORAGE}:/MediaCenterBox'
    ports: 
      - '7878:7878'
      
  bazarr: #subtitles
    container_name: bazarr
    image: 'lscr.io/linuxserver/bazarr:latest'
    restart: unless-stopped
    #network_mode: host
    environment:
      - 'PUID=${PUID}'
      - 'PGID=${PGID}'
      - 'TZ=${TZ}'
      - UMASK_SET=022
    volumes:
      - '${ROOT}/MediaCenter/config/bazarr:/config'
      - '${HDDSTORAGE}:/MediaCenterBox'
    ports:
      - '6767:6767'

  plex-server:
    container_name: plex-server
    image: 'plexinc/pms-docker:latest'
    restart: unless-stopped
    environment:
      - 'PUID=${PUID}'
      - 'PGID=${PGID}'
      - 'TZ=${TZ}'
    network_mode: host
    volumes:
      - '${ROOT}/MediaCenter/config/plex/db:/config'
      - '${TRANSCODING_STORAGE}:/transcode'
      - '${HDDSTORAGE}/Completed:/MediaCenterBox'
    ports:
      - '32400:32400'

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    cap_add:
      - NET_BIND_SERVICE
    ports:
      - 80:3000
    volumes:
      - '${ROOT}/MediaCenter/config/homepage/config:/app/config' # Make sure your local config directory exists
      - '${HDDSTORAGE}:/MediaCenterBox'
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      HOMEPAGE_ALLOWED_HOSTS: '*'
      
  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - TZ=${TZ}
    ports:
      - "8191:8191"

  tailscale:
    image: tailscale/tailscale:stable
    container_name: tailscale
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ${ROOT}/MediaCenter/config/tailscale/config:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    command: >
      tailscaled

  youtarr-db:
    image: mariadb:10.3
    container_name: youtarr-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-123qweasd}
      MYSQL_DATABASE: ${DB_NAME:-youtarr}
      MYSQL_TCP_PORT: ${DB_PORT:-3321}
      # Set utf8mb4 as default for new installations
      # Previously youtarr always used root, so keeping this default for backwards compatibility
      MYSQL_USER: ${DB_USER:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD:-123qweasd}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "${DB_PORT:-3321}:${DB_PORT:-3321}"
    volumes:
      - ${ROOT}/MediaCenter/config/youtarr/database:/var/lib/mysql
      # macOS (Apple Silicon): comment the line above and use the named volume example below to avoid the MariaDB+virtiofs bug (see README/Troubleshooting)
      # - youtarr-db-data:/var/lib/mysql
      - ${ROOT}/MediaCenter/config/youtarr/config/mariadb.cnf:/etc/mysql/conf.d/charset.cnf:ro
    command: --port=${DB_PORT:-3321} --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-P", "${DB_PORT:-3321}", "-p${DB_PASSWORD:-123qweasd}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  youtarr:
    image: ${YOUTARR_IMAGE:-dialmaster/youtarr:latest}
    container_name: youtarr
    restart: unless-stopped
    # Optional: Run as specific UID:GID for security (defaults to root if not set per previous behavior)
    user: "${YOUTARR_UID:-0}:${YOUTARR_GID:-0}"
    depends_on:
      youtarr-db:
        condition: service_healthy
    environment:
      # DEPRECATED but retained for backwards compatibility with old images for now
      IN_DOCKER_CONTAINER: 1
      TZ: ${TZ:-UTC}
      DB_HOST: ${DB_HOST:-youtarr-db}
      DB_PORT: ${DB_PORT:-3321}
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-123qweasd}
      DB_NAME: ${DB_NAME:-youtarr}
      # Optional: Disable authentication (for platforms with external auth like Elfhosted)
      AUTH_ENABLED: ${AUTH_ENABLED:-}
      # Optional: Seed initial admin credentials for headless deployments
      AUTH_PRESET_USERNAME: ${AUTH_PRESET_USERNAME:-}
      AUTH_PRESET_PASSWORD: ${AUTH_PRESET_PASSWORD:-}
      # Logging configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # This is just informational and lets the app know where the videos will be stored on the host
      YOUTUBE_OUTPUT_DIR: ${YOUTUBE_OUTPUT_DIR}
      # Optional: Custom data path for platforms like Elfhosted (defaults to /usr/src/app/data)
      # This is the internal path where videos download inside the container and is not needed for most users
      # DATA_PATH: /storage/rclone/storagebox/youtube

    ports:
      - "3087:3011"
    volumes:
      - ${YOUTUBE_OUTPUT_DIR}:/usr/src/app/data
      - ${ROOT}/MediaCenter/config/youtarr/server/images:/app/server/images
      - ${ROOT}/MediaCenter/config/youtarr/config:/app/config
      - ${ROOT}/MediaCenter/config/youtarr/jobs:/app/jobs
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "--show-error", "--output", "/dev/null", "http://localhost:3011/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  wire-pod:
    container_name: wire-pod
    hostname: escapepod
    image: ghcr.io/kercre123/wire-pod:main
    restart: unless-stopped
    environment:
      WIREPOD_DATA_DIR: /data
    ports:
      # - "80:80"
      # - "443:443"
      - "8080:8080"
      - "8084:8084"
    volumes:
      - wire-pod-data:/data
      - wire-pod-images:/images
    healthcheck:
      test: [ "CMD", "curl", "-fsS", "http://localhost:8080/ok" ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  slskd:
    image: slskd/slskd
    container_name: slskd
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - SLSKD_REMOTE_CONFIGURATION=true
    volumes:
      - ${ROOT}/MediaCenter/config/slskd:/app
      - ${HDDSTORAGE}/Downloads:/app/downloads
    ports:
      - "5030:5030"
      - "5031:5031"
      - "50300:50300"

  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${ROOT}/MediaCenter/config/calibre-web:/config
      - ${HDDSTORAGE}/Completed/Books:/books
    ports:
      - "8083:8083"

  beets:
    image: lscr.io/linuxserver/beets:latest
    container_name: beets
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      # Enable cron daemon for scheduled imports
      - DOCKER_MODS=linuxserver/mods:universal-cron
    volumes:
      # Beets config & database
      - ${ROOT}/MediaCenter/config/beets:/config
      # Mount parent directory to enable hard linking
      - ${HDDSTORAGE}:/media
      # Import script
      - ${ROOT}/MediaCenter/config/beets/scripts:/scripts
      # Custom initialization (sets up cron)
      - ${ROOT}/MediaCenter/config/beets/custom-cont-init.d:/custom-cont-init.d:ro

volumes:
  portainer_data:
  wire-pod-images:
    driver: local
  wire-pod-data:
    driver: local